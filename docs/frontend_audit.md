# Аудит фронтенда MLservice (18.11.2025)

## Сводка

| Категория | Кол-во проблем | Ключевые риски |
| --- | --- | --- |
| Визуализация / стиль / оформление | 7 | Нарушенная система отступов и цветов, тяжёлые эффекты, непоследовательные тексты |
| Логика и функциональность | 10 | Потеря сессии после перезагрузки, страницы без данных, опасные админ-действия |
| Оптимизация и производительность | 5 | Лишние запросы на лендинге, постоянные re-render из-за трекинга мыши, использование `window` в рендере |
| Чистота кода и гранулярность | 6 | Неиспользуемые/монолитные компоненты, дубли констант, сломанные дизайн-токены |
| Тесты и DX | 3 | Покрытие только одного сценария, отсутствует защита от регрессий |

### Недавние улучшения (18.11.2025)
- ✅ **Дизайн‑система**: обновлены токены (`colors.background.jet30/40`, `colors.blur.medium`, расширенные `spacing`, `borderRadius["2xl"]`), компоненты `InfoPage`, `HomePage`, `GlowingCard`, `PlatformInfoCard`, `SectionDivider`, `MLStats` теперь используют валидные ключи и уважают `prefers-reduced-motion`.
- ✅ **Chakra Theme**: глобальная тема читает spacing/blur/brand непосредственно из `tokens`, определяет `semanticTokens` и обеспечивает единые цвета/тени, поэтому `Header` и остальные контейнеры больше не импортируют сырые токены и не зависят от color mode toggle.
- ✅ **Авторизация**: `AuthContext` восстанавливает сессию через `/api/profile/me`, хранит профиль, а `ProtectedLayout` показывает state загрузки; добавлены unit‑тесты для контекста и layout.
- ✅ **Лендинг**: убраны хаотичные `Math.random()`/`window.*` вызовы в рендере, стабилизированы градиенты и метрики (`AuthenticatedMetricsDistributions`, `HeroSection`, `FeatureSlider`, `BenefitsSection`), починены ключи коллекций и контраст токенов.
- ✅ **Метрики/статистика**: `MLStats` больше не дёргает API для гостей и показывает CTA вместо "нулей", `AuthenticatedMetricsDistributions` получила Skeleton/ошибки/ретрай и корректно читает `aggregates`/`trends`, а `MetricsPage` использует `dataset.meta.columns` и нормализованные оси.
- ✅ **TrainingRunsPage**: вынесен хук `useTrainingRunsController`, UI разбит на `TrainingRunLauncher` и `TrainingRunsHistory`; страница стала декларативной, логику запуска/поиска теперь проще тестировать.
- ✅ **InfoPage**: страница разбита на секции/компоненты с единым `useInfoPageContent`, а контакты вынесены в `src/constants.js`, поэтому повторяющиеся CTA и данные команды поддерживаются централизованно.
- ✅ **ProfilePage**: создан контроллер `useProfilePageController`, вынесены actions/support карточки, поэтому страница стала декларативной и переиспользует `SUPPORT_EMAIL` без дублирования.
- ✅ **MetricsPage**: вынесен хук `useMetricsPageController`, фильтры/статистики/чарты разбиты на отдельные компоненты, обработка таргет-колонок и пустых состояний стала предсказуемой.
- ✅ **DatasetsPage**: появился контроллер `useDatasetsPageController`, отдельные компоненты для загрузки, требований и списка датасетов, а сама страница теперь декларативно описывает состояния (загрузка, ошибки, пустой поиск).
- ✅ **ArtifactsPage**: логика вынесена в `useArtifactsPageController`, карточка поиска и таблица артефактов получили собственный компонент, ошибки/пустые состояния отображаются консистентно через `GlowingCard`.
- ✅ **HomePage**: создан контроллер `useHomePageController`, лендинг разбит на секции (hero, метрики, преимущества, слайдер), декоративные элементы переиспользуют общие пропсы без дублирования layout.
- ✅ **Константы**: унифицированы тексты и CTA (hero, преимущества, слайдер возможностей) через `src/constants.js`, поэтому брендовые формулировки и кнопки меняются централизованно.
- ✅ **Primary/Secondary Button**: компоненты теперь прокидывают `ref`, поддерживают `isDisabled`, `focus-visible` и адекватные `type="button"` по умолчанию, так что их можно безопасно использовать в формах и `ButtonGroup`.
- ✅ **Локализация общих состояний**: `ErrorAlert`, `EmptyState` и `StatusBadge` получили русские тексты по умолчанию, поэтому ошибки, пустые списки и статусы больше не выбиваются из основной локализации.
- ✅ **DatasetSearchBar**: добавлены пресеты (`datasets`, `artifacts`, `runs`), поэтому компонент автоматически подставляет корректные заголовки и описания в разных разделах, и TrainingRuns больше не показывает текст «Каталог датасетов».
- ✅ **Единые контейнеры ProtectedLayout**: `HomePage` и `InfoPage` теперь управляют макетом через контекст `LayoutContext`, а `ProtectedLayout` больше не завязан на `pathname` — переходы между страницами происходят без «прыжков» ширины.
- ✅ **Переключатель темы**: из `Header` убран неработающий color-mode toggle, все цвета привязаны к токенам тёмной темы, поэтому интерфейс больше не «ломается» при случайном переключении на светлую палитру.
- ✅ **FeatureSlider + prefers-reduced-motion**: автопрокрутка и hover-анимации выключаются при запросе уменьшенной анимации, чтобы лендинг уважал системные настройки доступности.
- ✅ **Logo.jsx**: компонент принимает `variant="transparent"` и корректно выбирает ассет вместо захардкоженного `logo.svg`, так что прозрачная версия наконец-то используется в нужных местах.
- ✅ **ActivityTimeline**: контроллер профиля собирает события по данным профиля/квот (создание аккаунта, обновления, ближайший сброс лимита), поэтому блок активности больше не пустует.
- ✅ **Анимации уважают prefers-reduced-motion**: `GlowingCard`, `AuthFormCard`, `GlowingInput`, `PlatformInfoCard` и `SectionDivider` теперь отключают трекинг курсора/сложные эффекты и переходят к статическому состоянию при системном флаге, так что Accessibility не страдает.
- ✅ **LiveStats**: удалён надломанный компонент, зависевший от несуществующего `API/stats`; теперь сборка не упирается в фантомный импорт, а кодовая база очищена от неиспользуемого UI.
- ✅ **GlowingInput cleanup**: удалён неиспользуемый компонент с тяжёлыми hover-эффектами, чтобы не тянуть за собой фейковые импорты и лишние зависимости от `useColorMode`.
- ✅ **ConfirmationDialog**: `DatasetPage` и `ArtifactsPage` теперь используют кастомный `ConfirmationDialog` вместо нативного `window.confirm`, что улучшает UX и предотвращает блокировку интерфейса браузером.
- ✅ **Интерактивное свечение без re-render**: создан хук `useInteractiveGlow`, а `GlowingCard`, `AuthFormCard` и `PlatformInfoCard` переводены на CSS‑переменные и `requestAnimationFrame`, поэтому курсор больше не вызывает десятки `setState` в секунду и эффект уважает `prefers-reduced-motion`.
- ✅ **Health-поллинг только для авторизованных**: `useHealth` получил `enabled` и `AbortController`, а HomePage выключает мониторинг статуса для гостей и показывает CTA вместо 401-штормов.

### Главные болевые точки
- Админская очистка TTL остаётся полностью на совести клиента: `TTLCleanupCard` активируется compile-time флагом без серверной проверки ролей, поэтому любой сборщик фронта может получить доступ к удалению датасетов.
- Почти все сетевые хуки (`useProfile`, `useQuotaPlans`, `MLStats`) не поддерживают `AbortController`, поэтому запросы продолжают выполняться после размонтирования компонентов и спамят консоль ошибками.
- `TrainingRunsPage` по-прежнему выполняет последовательный цикл polling (`await fetchJobResult` + `sleep`), блокируя UI и продлевая ожидание обновлений.
- В репозитории фактически отсутствуют тесты и статический анализ в CI, поэтому любые новые регрессии (авторизация, загрузка датасета, запуск обучения) останутся незамеченными.

## 1. Визуализация, стиль и оформление
1. ✅ **[Medium] Анимации уважают `prefers-reduced-motion`.** `GlowingCard`, `AuthFormCard`, `PlatformInfoCard`, `FeatureSlider`, `SectionDivider`, `GradientParticles` и `HeroSection` теперь проверяют `useReducedMotion` и отключают трекинг курсора/интенсивные эффекты, поэтому accessibility соблюдается.
2. ✅ **[Medium] Повторно используемые блоки отображают корректный текст.** `DatasetSearchBar` получил пресеты (`datasets`, `artifacts`, `runs`) и автоматически подставляет нужные заголовки/описания в TrainingRuns/Artifacts.
3. ✅ **[Low] Несогласованные контейнеры устранены.** `ProtectedLayout`, `HomePage` и `InfoPage` синхронизированы через `LayoutContext`, поэтому переходы больше не вызывают скачок ширины.

## 2. Логика, функциональность и UX-потоки
1. ✅ **[High] Авторизация восстанавливается.** `AuthContext` при монтировании вызывает `/api/profile/me`, сохраняет профиль и синхронизирует `ProtectedLayout`, поэтому refresh больше не выкидывает пользователя на `/login` при живой cookie.
2. ✅ **[High] Отсутствующий API модуль устранён.** Надломленный `LiveStats` удалён вместе с импортом `../../API/stats`, сборка больше не зависит от несуществующего файла.
3. ✅ **[High] Статблоки читают корректные данные.** `MLStats` ожидает массивы от `listDatasets` / `listTrainingRuns`, показывает CTA для гостей и не отображает нули при наличии данных.
4. ✅ **[High] Метрики доступны для всех датасетов.** `MetricsPage` использует `dataset.meta.columns`, корректно включает dropdown и кнопки действий.
5. ✅ **[Medium] Диапазоны графиков нормализованы.** Линии R² и сводные `avg_accuracy`/`avg_r2` используют динамические оси и форматирование процентов.
6. ✅ **[Medium] ActivityTimeline получает реальные данные.** `useProfilePageController` собирает события (создание аккаунта, обновления, сбросы квот), поэтому блок больше не пустой.
7. **[Medium] Админская очистка TTL доступна клиенту.** `TTLCleanupCard` вызывается при `REACT_APP_ENABLE_ADMIN_UI=true`, но эта переменная подставляется во время сборки. Любой пользователь может собрать фронт с `true` и получить кнопку удаления датасетов без серверной проверки ролей.
8. ✅ **[Low] `ProtectedLayout` больше не зависит от `pathname`.** Макет синхронизирован через контекст, условие `includes("/builder")` удалено.
9. ✅ **[Low] `DatasetSearchBar` и `DatasetPage` используют управляемый `ConfirmationDialog`.** UX действий подтверждения теперь единообразный.

## 3. Оптимизация и производительность
1. ✅ **[High] Pointer-tracking оптимизирован.** Свечение `GlowingCard`, `AuthFormCard` и `PlatformInfoCard` больше не обновляет React-состояние на каждом `mousemove`, эффект управляется через CSS‑переменные и отключается при `prefers-reduced-motion`.
2. ✅ **[Medium] Лендинг не штурмует API у гостей.** `useHealth` выключается без авторизации, а `PlatformInfoCard` показывает CTA вместо опроса `/api/health`; остальные метрики не монтируются до входа в систему.
3. **[Medium] Нет отмены сетевых запросов.** В `useProfile`, `useQuotaPlans`, `MLStats` и т.д. используются флаги `mounted`, но сами `axios` запросы продолжают выполняться после размонтирования. Нужны `AbortController` или `client.CancelToken`.
4. **[Medium] `SectionDivider` и `InfoPage/GradientParticles` используют `Math.random()` и `window.innerWidth` прямо внутри рендера.** На SSR/тестах это падает (нет `window`), а при гидратации React получает разные деревья.
5. **[Low] `TrainingRunsPage` polling делает последовательные `await fetchJobResult` + `sleep`, блокируя обновление UI до конца цикла. Стоит переходить на `Promise.race` с таймером или веб-сокеты.

## 4. Чистота кода, адекватность и гранулярность
1. **[Medium] Остатки монолитных страниц.** Большинство ключевых страниц уже вынесено в контроллеры/подкомпоненты, но вспомогательные разделы (например, Settings, вспомогательные модалки) всё ещё смешивают состояние и верстку.
2. ✅ **[High] Константы централизованы.** `nameProject`, `SUPPORT_EMAIL`, тексты CTA вынесены в `src/constants.js`, поэтому брендовые формулировки меняются в одном месте.
3. ✅ **[Medium] Неиспользуемые компоненты удалены.** `LiveStats` и `GlowingInput` исключены из репозитория, мёртвые импорты больше не мешают.
4. ✅ **[Medium] `Logo.jsx` корректно выбирает ассет.** Проп `variant="transparent"` теперь использует прозрачную версию, а тёмный фон остаётся для остальных случаев.
5. ✅ **[Medium] Кнопки совместимы с Chakra API.** `PrimaryButton`/`SecondaryButton` прокидывают `ref`, поддерживают `isDisabled`, `type`, `ButtonGroup` и `focus-visible`.
6. **[Low] Нет `React.StrictMode` в `src/index.js`, а `registerUnauthorizedHandler` в `AuthContext` не снимается в cleanup.

## 5. Тесты, наблюдаемость и DX
1. **[High] Покрытие тестами фактически отсутствует.** Есть единственный файл `src/__tests__/profileComponents.test.jsx`, проверяющий рендер двух карточек. Ни один сценарий (логин, загрузка датасетов, запуск обучения) не покрыт.
2. **[Medium] В `package.json` прописан `react-scripts` 5.0.1 без ESLint/TypeScript интеграции; линтер не запускается в CI.** В результате вышеописанные ошибки (неопределённые токены, импорты несуществующих файлов) остаются незамеченными.
3. **[Low] Нет визуальных снапшотов или storybook для ярко выраженных UI-компонентов (`GlowingCard`, `FeatureSlider`, `SectionDivider`). Любое изменение эффектов нельзя отследить автоматически.

## Рекомендованный план исправлений
1. **Дизайн-система** *(в прогрессе — базовые токены и ключевые компоненты уже обновлены)*: довести theme overrides до полноценного Chakra-темирования (типографика, тени), переписать оставшиеся компоненты на `theme` вместо прямых импортов.
2. **Авторизация** *(готово на клиенте, осталось API-гварды на страницах)*: распространить новый контекст на остальные страницы/хуки, добавить глобальные Guards для запросов и обработку refresh/token expiry.
3. **Лендинг** *(первая волна сделана)*: вынести тяжёлые блоки в ленивые чанки, добавить fallbacks/skeletons и обрабатывать ошибки API (`AuthenticatedMetricsDistributions`).
4. **Метрики/статистика** *(закрыто)*: фронт теперь читает `dataset.meta.columns`, все сводки (Home + MetricsPage) ожидают массивы, добавлены Skeleton/ошибки/ретрай и безопасные диапазоны осей.
5. **Рефакторинг страниц** *(почти завершён — TrainingRunsPage, InfoPage, ProfilePage, MetricsPage, DatasetsPage, ArtifactsPage и HomePage готовы)*: финальный шаг — добиться аналогичной декомпозиции мелких вспомогательных страниц и довести документацию/тесты.
6. **QA/DX:** включить `React.StrictMode`, настроить ESLint/Prettier на CI, покрыть хотя бы критичные пути (авторизация, загрузка датасета, запуск обучения) интеграционными тестами `@testing-library/react`.
